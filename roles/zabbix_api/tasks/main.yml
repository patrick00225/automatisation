---
# roles/zabbix_api/tasks/main.yml

# --------------------------
# 1️⃣ Authentification Zabbix
# --------------------------
- name: Authenticate to Zabbix API
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        username: "{{ zabbix_user }}"
        password: "{{ zabbix_password }}"
      id: 1
    headers:
      Content-Type: "application/json"
  register: login_response
  failed_when: login_response.status != 200

- name: Debug login response
  debug:
    var: login_response.json

- name: Fail if login failed
  fail:
    msg: "Zabbix login failed: {{ login_response.json }}"
  when: login_response.json.result is not defined

- name: Set auth token
  set_fact:
    zabbix_auth: "{{ login_response.json.result }}"

# --------------------------
# 2️⃣ Création du host
# --------------------------
- name: Create host in Zabbix
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "host.create"
      params:
        host: "test-host"
        interfaces:
          - type: 1
            main: 1
            useip: 1
            ip: "192.168.1.100"
            dns: ""
            port: "10050"
        groups:
          - groupid: "{{ zabbix_groupid }}"
      id: 1
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ zabbix_auth }}"
  register: zabbix_create_host
  failed_when: zabbix_create_host.json.error is defined


