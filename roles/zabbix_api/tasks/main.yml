---
# 1️⃣ Authentification
- name: Authenticate to Zabbix API
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        username: "{{ zabbix_user }}"
        password: "{{ zabbix_password }}"
      id: 1
    headers:
      Content-Type: "application/json"
  register: login_response
  failed_when: login_response.status != 200

- name: Set auth token
  set_fact:
    zabbix_auth: "{{ login_response.json.result }}"

# 2️⃣ Récupérer l'ID du groupe à partir du nom
- name: Get groupid from group name
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "hostgroup.get"
      params:
        output: "extend"
        filter:
          name: ["{{ zabbix_group_name }}"]
      id: 2
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ zabbix_auth }}"
  register: zabbix_group

- name: Fail if group not found
  fail:
    msg: "Zabbix group '{{ zabbix_group_name }}' not found"
  when: zabbix_group.json.result | length == 0

- name: Set groupid fact
  set_fact:
    zabbix_groupid: "{{ zabbix_group.json.result[0].groupid }}"

# 3️⃣ Vérifier si le host existe déjà
# 1️⃣ Vérifier si le host existe
- name: Check if host exists
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "host.get"
      params:
        filter:
          host: "{{ host_name }}"
      auth: "{{ zabbix_auth }}"
      id: 1
    headers:
      Content-Type: "application/json"
  register: host_check

# 2️⃣ Préparer le payload
- name: Prepare host payload
  set_fact:
    zabbix_host_payload: >-
      {{
        {
          'host': host_name,
          'interfaces': [{
            'type': 1,
            'main': 1,
            'useip': 1,
            'ip': host_ip,
            'dns': '',
            'port': '10050'
          }],
          'groups': [{'groupid': zabbix_groupid}]
        }
        | combine({'hostid': host_check.json.result[0].hostid} if host_check.json.result | length > 0 else {})
      }}

# 3️⃣ Créer ou mettre à jour le host
- name: Create or update host in Zabbix
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "{{ 'host.update' if host_check.json.result | length > 0 else 'host.create' }}"
      params: "{{ zabbix_host_payload }}"
      auth: "{{ zabbix_auth }}"
      id: 1
    headers:
      Content-Type: "application/json"
  register: zabbix_host_result

- name: Debug host creation/update response
  debug:
    var: zabbix_host_result.json
